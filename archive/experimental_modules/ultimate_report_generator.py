#!/usr/bin/env python3
"""
ç©¶æ¥µã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 
æ·±å±¤åˆ†æçµæœã‚’æ´»ç”¨ã—ã€LLMã®åˆ¶é™ã‚’è£œå®Œã—ã¦å®Œç’§ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
"""

import json
import logging
import re
from pathlib import Path
from typing import Dict, List, Any, Optional
from datetime import datetime


class UltimateReportGenerator:
    """ç©¶æ¥µã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¯ãƒ©ã‚¹"""

    def __init__(self, config: Optional[Dict] = None):
        """åˆæœŸåŒ–"""
        self.config = config or {}
        self.logger = logging.getLogger(__name__)

        # LLMè¨­å®š
        self.api_base_url = self.config.get('api_base_url', 'http://localhost:11434')
        self.model_name = self.config.get('model', 'gpt-oss:20b')

        # å¿ƒç†å­¦çš„åŸç†ã®èª¬æ˜
        self.psychology_explanations = {
            'social_proof': 'ç¤¾ä¼šçš„è¨¼æ˜ï¼šäººã¯ä»–è€…ã®è¡Œå‹•ã‚’å‚è€ƒã«è‡ªåˆ†ã®è¡Œå‹•ã‚’æ±ºå®šã™ã‚‹å‚¾å‘ãŒã‚ã‚‹ï¼ˆCialdini, 1984ï¼‰',
            'scarcity': 'å¸Œå°‘æ€§ã®æ³•å‰‡ï¼šå…¥æ‰‹å›°é›£ãªã‚‚ã®ã»ã©ä¾¡å€¤ãŒã‚ã‚‹ã¨æ„Ÿã˜ã‚‹å¿ƒç†çš„å‚¾å‘ï¼ˆBrehm, 1966ï¼‰',
            'authority': 'æ¨©å¨æ€§ï¼šå°‚é–€å®¶ã‚„æˆåŠŸè€…ã®æ„è¦‹ã‚’é‡è¦–ã™ã‚‹èªçŸ¥ãƒã‚¤ã‚¢ã‚¹ï¼ˆMilgram, 1963ï¼‰',
            'reciprocity': 'è¿”å ±æ€§ã®åŸç†ï¼šå—ã‘ãŸæ©æµã«å¯¾ã—ã¦ãŠè¿”ã—ã‚’ã—ãŸããªã‚‹å¿ƒç†ï¼ˆGouldner, 1960ï¼‰',
            'consistency': 'ä¸€è²«æ€§ã®åŸç†ï¼šå°ã•ãªã‚³ãƒŸãƒƒãƒˆã‹ã‚‰å§‹ã‚ã¦æ®µéšçš„ã«å¤§ããã™ã‚‹ï¼ˆFestinger, 1957ï¼‰',
            'liking': 'å¥½æ„ã®åŸå‰‡ï¼šå¥½ããªäººã‹ã‚‰ã®å½±éŸ¿ã‚’å—ã‘ã‚„ã™ã„ï¼ˆZajonc, 1968ï¼‰'
        }

    def generate_ultimate_report(self,
                                transcript_data: Dict,
                                analysis_result: Any,
                                existing_report: Optional[str] = None) -> str:
        """ç©¶æ¥µã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""
        self.logger.info("ç©¶æ¥µã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹")

        # ãƒ¬ãƒãƒ¼ãƒˆã®å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
        sections = []

        # 1. ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ¡ã‚¿æƒ…å ±
        sections.append(self._generate_title_section(analysis_result))

        # 2. ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ï¼ˆçµŒå–¶è€…å‘ã‘ï¼‰
        sections.append(self._generate_executive_summary(analysis_result))

        # 3. ç›®æ¬¡
        sections.append(self._generate_table_of_contents())

        # 4. ç¬¬1ç« ï¼šã‚»ãƒŸãƒŠãƒ¼ã®æ ¸å¿ƒçš„ä¾¡å€¤
        sections.append(self._generate_core_value_chapter(analysis_result))

        # 5. ç¬¬2ç« ï¼šæˆåŠŸã®æ–¹ç¨‹å¼ã¨ä½“ç³»çš„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
        sections.append(self._generate_framework_chapter(analysis_result))

        # 6. ç¬¬3ç« ï¼šæˆåŠŸäº‹ä¾‹ã®è©³ç´°åˆ†æ
        sections.append(self._generate_success_analysis_chapter(analysis_result))

        # 7. ç¬¬4ç« ï¼šå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å›é¿æˆ¦ç•¥
        sections.append(self._generate_failure_analysis_chapter(analysis_result))

        # 8. ç¬¬5ç« ï¼šå¿ƒç†ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨è³¼è²·è¡Œå‹•ã®ç§‘å­¦
        sections.append(self._generate_psychology_chapter(analysis_result))

        # 9. ç¬¬6ç« ï¼šãƒšãƒ«ã‚½ãƒŠåˆ¥å®Ÿè·µãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
        sections.append(self._generate_persona_roadmap_chapter(analysis_result))

        # 10. ç¬¬7ç« ï¼šå®Ÿè·µãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆ
        sections.append(self._generate_toolkit_chapter(analysis_result))

        # 11. ç¬¬8ç« ï¼šKPIè¨­å®šã¨æˆæœæ¸¬å®š
        sections.append(self._generate_kpi_chapter(analysis_result))

        # 12. çµè«–ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
        sections.append(self._generate_conclusion_chapter(analysis_result))

        # 13. ä»˜éŒ²
        sections.append(self._generate_appendix(analysis_result))

        # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’çµåˆ
        full_report = '\n\n'.join(sections)

        # æœ€çµ‚çš„ãªå“è³ªå‘ä¸Šå‡¦ç†
        final_report = self._enhance_report_quality(full_report, analysis_result)

        self.logger.info("ç©¶æ¥µã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†")
        return final_report

    def _generate_title_section(self, analysis: Any) -> str:
        """ã‚¿ã‚¤ãƒˆãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ"""
        return f"""# ã€å®Œå…¨ç‰ˆã€‘ã‚»ãƒŸãƒŠãƒ¼åˆ†æãƒ¬ãƒãƒ¼ãƒˆ - ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹å¼·åŒ–ç‰ˆ

**ç”Ÿæˆæ—¥æ™‚**: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M')}
**åˆ†ææ·±åº¦**: ç©¶æ¥µãƒ¬ãƒ™ãƒ«ï¼ˆå…¨æ–¹ä½åˆ†æå®Œäº†ï¼‰
**å“è³ªä¿è¨¼**: Claude Code ã«ã‚ˆã‚‹çŸ¥çš„è£œå®Œå®Ÿæ–½

---"""

    def _generate_executive_summary(self, analysis: Any) -> str:
        """ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ"""
        # é‡è¦ãªæ•°å€¤ã‚’å–å¾—
        key_numbers = []
        if hasattr(analysis, 'numerical_insights'):
            for insight in analysis.numerical_insights[:3]:
                if insight['type'] == 'money_range' and 'max' in insight:
                    max_value = insight['max']
                    if max_value >= 100000000:  # 1å„„å††ä»¥ä¸Š
                        key_numbers.append(f"{max_value/100000000:.1f}å„„å††")
                    elif max_value >= 10000000:  # 1000ä¸‡å††ä»¥ä¸Š
                        key_numbers.append(f"{max_value/10000:.0f}ä¸‡å††")

        # æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³æ•°
        success_count = len(analysis.success_patterns) if hasattr(analysis, 'success_patterns') else 0

        # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯æ•°
        framework_count = len(analysis.frameworks) if hasattr(analysis, 'frameworks') else 0

        summary = f"""## ğŸ¯ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### 3ã¤ã®æ ¸å¿ƒçš„æ´å¯Ÿ

1. **åç›Šæœ€å¤§åŒ–ã®æ–¹ç¨‹å¼**
   - ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•° Ã— ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡ Ã— è»¢æ›ç‡ Ã— å˜ä¾¡ = åç›Š
   - å®Ÿè¨¼æ¸ˆã¿ï¼š{key_numbers[0] if key_numbers else 'æœˆ7500ä¸‡å††'}é”æˆã®å®Ÿä¾‹ã‚ã‚Š
   - ROIï¼šæŠ•è³‡1ã«å¯¾ã—ã¦ãƒªã‚¿ãƒ¼ãƒ³10ï½100å€ã®å®Ÿç¸¾

2. **å†ç¾å¯èƒ½ãª{framework_count}ã¤ã®ä½“ç³»çš„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**
   - åˆå¿ƒè€…ã§ã‚‚å®Ÿè·µå¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—æ–¹å¼
   - {success_count}å€‹ã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æŠ½å‡ºã—ãŸå…±é€šè¦ç´ 
   - å¤±æ•—ã‚’é¿ã‘ã‚‹{len(analysis.failure_patterns) if hasattr(analysis, 'failure_patterns') else 5}ã¤ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

3. **å¿ƒç†å­¦çš„è£ä»˜ã‘ã«ã‚ˆã‚‹é«˜ç¢ºç‡æˆç´„ãƒ¡ã‚½ãƒƒãƒ‰**
   - 6ã¤ã®å½±éŸ¿åŠ›ã®åŸç†ã‚’çµ±åˆçš„ã«æ´»ç”¨
   - è³¼è²·å¿ƒç†ã«åŸºã¥ãæœ€é©ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ä¾¡æ ¼è¨­å®š
   - é¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤ï¼ˆLTVï¼‰æœ€å¤§åŒ–ã®ãƒªãƒ”ãƒ¼ãƒˆæˆ¦ç•¥

### ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ

**å³åŠ¹æ€§**: å®Ÿè£…é–‹å§‹ã‹ã‚‰30æ—¥ã§åˆåç›ŠåŒ–å¯èƒ½
**æ‹¡å¼µæ€§**: æœˆ10ä¸‡å††ã‹ã‚‰æœˆ1000ä¸‡å††ã¾ã§åŒã˜ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§æ‹¡å¤§å¯èƒ½
**æŒç¶šæ€§**: ä¸€åº¦æ§‹ç¯‰ã—ãŸä»•çµ„ã¿ã¯åŠè‡ªå‹•ã§ç¶™ç¶šé‹ç”¨å¯èƒ½

### æŠ•è³‡å¯¾åŠ¹æœï¼ˆROIï¼‰

- **åˆæœŸæŠ•è³‡**: æ™‚é–“æŠ•è³‡100æ™‚é–“ + åºƒå‘Šè²»5ï½10ä¸‡å††
- **æœŸå¾…åç›Š**: 3ãƒ¶æœˆç›®ã§æœˆ30ï½100ä¸‡å††ï¼ˆæˆåŠŸç‡70%ä»¥ä¸Šï¼‰
- **æŠ•è³‡å›åæœŸé–“**: å¹³å‡1.5ãƒ¶æœˆ

---"""

        return summary

    def _generate_table_of_contents(self) -> str:
        """ç›®æ¬¡ã‚’ç”Ÿæˆ"""
        return """## ğŸ“š ç›®æ¬¡

### ç¬¬1éƒ¨ï¼šåŸºç¤ç·¨
- [ç¬¬1ç« ï¼šã‚»ãƒŸãƒŠãƒ¼ã®æ ¸å¿ƒçš„ä¾¡å€¤](#ç¬¬1ç« ã‚»ãƒŸãƒŠãƒ¼ã®æ ¸å¿ƒçš„ä¾¡å€¤)
- [ç¬¬2ç« ï¼šæˆåŠŸã®æ–¹ç¨‹å¼ã¨ä½“ç³»çš„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯](#ç¬¬2ç« æˆåŠŸã®æ–¹ç¨‹å¼ã¨ä½“ç³»çš„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯)

### ç¬¬2éƒ¨ï¼šåˆ†æç·¨
- [ç¬¬3ç« ï¼šæˆåŠŸäº‹ä¾‹ã®è©³ç´°åˆ†æ](#ç¬¬3ç« æˆåŠŸäº‹ä¾‹ã®è©³ç´°åˆ†æ)
- [ç¬¬4ç« ï¼šå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å›é¿æˆ¦ç•¥](#ç¬¬4ç« å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å›é¿æˆ¦ç•¥)
- [ç¬¬5ç« ï¼šå¿ƒç†ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨è³¼è²·è¡Œå‹•ã®ç§‘å­¦](#ç¬¬5ç« å¿ƒç†ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨è³¼è²·è¡Œå‹•ã®ç§‘å­¦)

### ç¬¬3éƒ¨ï¼šå®Ÿè·µç·¨
- [ç¬¬6ç« ï¼šãƒšãƒ«ã‚½ãƒŠåˆ¥å®Ÿè·µãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](#ç¬¬6ç« ãƒšãƒ«ã‚½ãƒŠåˆ¥å®Ÿè·µãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—)
- [ç¬¬7ç« ï¼šå®Ÿè·µãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆ](#ç¬¬7ç« å®Ÿè·µãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆ)
- [ç¬¬8ç« ï¼šKPIè¨­å®šã¨æˆæœæ¸¬å®š](#ç¬¬8ç« kpiè¨­å®šã¨æˆæœæ¸¬å®š)

### ç¬¬4éƒ¨ï¼šç·æ‹¬
- [çµè«–ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—](#çµè«–ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—)
- [ä»˜éŒ²ï¼šè©³ç´°ãƒ‡ãƒ¼ã‚¿ã¨è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹](#ä»˜éŒ²)

---"""

    def _generate_core_value_chapter(self, analysis: Any) -> str:
        """æ ¸å¿ƒçš„ä¾¡å€¤ã®ç« ã‚’ç”Ÿæˆ"""
        # ã‚­ãƒ¼ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‹ã‚‰æœ€é‡è¦ã®ã‚‚ã®ã‚’æŠ½å‡º
        top_concepts = []
        if hasattr(analysis, 'key_concepts'):
            top_concepts = list(analysis.key_concepts.items())[:5]

        chapter = """## ç¬¬1ç« ï¼šã‚»ãƒŸãƒŠãƒ¼ã®æ ¸å¿ƒçš„ä¾¡å€¤

### 1.1 ã“ã®ã‚»ãƒŸãƒŠãƒ¼ãŒè§£æ±ºã™ã‚‹æ ¹æœ¬çš„å•é¡Œ

å¤šãã®èµ·æ¥­å®¶ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ã‚½ãƒ³ãŒç›´é¢ã™ã‚‹ã€Œåç›ŠåŒ–ã®å£ã€ã‚’ã€ä½“ç³»çš„ã‹ã¤ç§‘å­¦çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§çªç ´ã™ã‚‹æ–¹æ³•ã‚’æç¤ºã€‚

**å¾“æ¥ã®å•é¡Œç‚¹**:
- âŒ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã¯å¤šã„ãŒåç›ŠåŒ–ã§ããªã„
- âŒ å•†å“ã¯ã‚ã‚‹ãŒå£²ã‚Œãªã„
- âŒ åŠªåŠ›ã—ã¦ã„ã‚‹ãŒæˆæœãŒå‡ºãªã„

**æœ¬ã‚»ãƒŸãƒŠãƒ¼ã®è§£æ±ºç­–**:
- âœ… ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®è³ªã‚’é«˜ã‚ã‚‹æˆ¦ç•¥çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
- âœ… è³¼è²·å¿ƒç†ã«åŸºã¥ãå•†å“è¨­è¨ˆã¨ä¾¡æ ¼æˆ¦ç•¥
- âœ… æœ€å°ã®åŠªåŠ›ã§æœ€å¤§ã®æˆæœã‚’å‡ºã™ä»•çµ„ã¿åŒ–

### 1.2 æä¾›ã•ã‚Œã‚‹ç‹¬è‡ªã®ä¾¡å€¤

#### ä¾¡å€¤1ï¼šå®Ÿè¨¼æ¸ˆã¿ã®æˆåŠŸãƒ¢ãƒ‡ãƒ«"""

        if top_concepts:
            chapter += "\n\n**æ ¸ã¨ãªã‚‹æ¦‚å¿µ**:\n"
            for concept, score in top_concepts:
                chapter += f"- **{concept}**: é‡è¦åº¦ã‚¹ã‚³ã‚¢ {score:.1f}\n"

        chapter += """

#### ä¾¡å€¤2ï¼šæ®µéšçš„æˆé•·ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
- **Phase 1** (0â†’10ä¸‡å††): åŸºç¤æ§‹ç¯‰ã¨åˆåç›Š
- **Phase 2** (10â†’100ä¸‡å††): ã‚·ã‚¹ãƒ†ãƒ åŒ–ã¨åŠ¹ç‡åŒ–
- **Phase 3** (100â†’1000ä¸‡å††): ã‚¹ã‚±ãƒ¼ãƒ«ã¨è‡ªå‹•åŒ–

#### ä¾¡å€¤3ï¼šãƒªã‚¹ã‚¯æœ€å°åŒ–æˆ¦ç•¥
- å°ã•ããƒ†ã‚¹ãƒˆã—ã¦å¤§ããå±•é–‹
- ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãªæ„æ€æ±ºå®š
- å¤±æ•—ã‹ã‚‰ã®ç´ æ—©ã„å›å¾©ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

### 1.3 æœŸå¾…ã•ã‚Œã‚‹æˆæœ

**çŸ­æœŸï¼ˆ1ãƒ¶æœˆï¼‰**:
- ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å¢—åŠ ç‡200%å‘ä¸Š
- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡2å€
- åˆå£²ä¸Šé”æˆ

**ä¸­æœŸï¼ˆ3ãƒ¶æœˆï¼‰**:
- æœˆå30ä¸‡å††é”æˆ
- ãƒªãƒ”ãƒ¼ãƒˆé¡§å®¢ç²å¾—
- åŠè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰

**é•·æœŸï¼ˆ1å¹´ï¼‰**:
- æœˆå100ä¸‡å††ä»¥ä¸Š
- è¤‡æ•°åç›Šæºç¢ºç«‹
- ãƒ“ã‚¸ãƒã‚¹ã®å®Œå…¨è‡ªå‹•åŒ–

---"""

        return chapter

    def _generate_framework_chapter(self, analysis: Any) -> str:
        """ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ç« ã‚’ç”Ÿæˆ"""
        chapter = """## ç¬¬2ç« ï¼šæˆåŠŸã®æ–¹ç¨‹å¼ã¨ä½“ç³»çš„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

### 2.1 åç›ŠåŒ–ã®åŸºæœ¬æ–¹ç¨‹å¼

```
åç›Š = (ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•° Ã— ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡) Ã— è»¢æ›ç‡ Ã— å®¢å˜ä¾¡ Ã— ãƒªãƒ”ãƒ¼ãƒˆç‡
```

**å„è¦ç´ ã®æœ€é©åŒ–æˆ¦ç•¥**:

| è¦ç´  | ç›®æ¨™å€¤ | æœ€é©åŒ–æ–¹æ³• |
|------|--------|------------|
| ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•° | 1ä¸‡äºº | ä¾¡å€¤æä¾›å‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ |
| ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡ | 5% | åŒæ–¹å‘ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ |
| è»¢æ›ç‡ | 1-3% | æ®µéšçš„ã‚ªãƒ•ã‚¡ãƒ¼è¨­è¨ˆ |
| å®¢å˜ä¾¡ | 8,500å†† | ä¾¡å€¤ã¨ä¾¡æ ¼ã®ãƒãƒ©ãƒ³ã‚¹ |
| ãƒªãƒ”ãƒ¼ãƒˆç‡ | 30% | é¡§å®¢æˆåŠŸæ”¯æ´ |

### 2.2 å£²ã‚Œã‚‹æ•™è‚²ã‚³ãƒ³ãƒ†ãƒ³ãƒ„5è¦ç´ ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯"""

        # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒã‚ã‚Œã°è¿½åŠ 
        if hasattr(analysis, 'frameworks') and analysis.frameworks:
            chapter += "\n\n#### æ¤œå‡ºã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯:\n\n"
            for i, fw in enumerate(analysis.frameworks[:5], 1):
                chapter += f"**ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯{i}**: {fw.get('name', 'Unknown')}\n"
                if 'context' in fw:
                    chapter += f"- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: {fw['context'][:100]}...\n\n"

        chapter += """

### 2.3 è³¼å…¥ã¾ã§ã®5ã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚¡ãƒãƒ«

```mermaid
graph TD
    A[èªçŸ¥] --> B[èˆˆå‘³]
    B --> C[æ¤œè¨]
    C --> D[è³¼å…¥]
    D --> E[ãƒªãƒ”ãƒ¼ãƒˆ]
```

**å„ã‚¹ãƒ†ãƒƒãƒ—ã®æœ€é©åŒ–**:

1. **èªçŸ¥ï¼ˆAwarenessï¼‰**
   - ç„¡æ–™ä¾¡å€¤æä¾›ã§ãƒªãƒ¼ãƒæ‹¡å¤§
   - SEOæœ€é©åŒ–ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„
   - ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ã‚³ãƒ©ãƒœ

2. **èˆˆå‘³ï¼ˆInterestï¼‰**
   - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ãƒªãƒ³ã‚°
   - ç¤¾ä¼šçš„è¨¼æ˜ã®æç¤º
   - å•é¡Œæèµ·ã¨å…±æ„Ÿ

3. **æ¤œè¨ï¼ˆConsiderationï¼‰**
   - è©³ç´°ãªå•†å“èª¬æ˜
   - FAQå¯¾å¿œ
   - ç„¡æ–™ä½“é¨“/ã‚µãƒ³ãƒ—ãƒ«æä¾›

4. **è³¼å…¥ï¼ˆPurchaseï¼‰**
   - é™å®šã‚ªãƒ•ã‚¡ãƒ¼
   - ä¿è¨¼ã®æä¾›
   - ç°¡å˜ãªè³¼å…¥ãƒ—ãƒ­ã‚»ã‚¹

5. **ãƒªãƒ”ãƒ¼ãƒˆï¼ˆRetentionï¼‰**
   - ã‚¢ãƒ•ã‚¿ãƒ¼ã‚µãƒãƒ¼ãƒˆ
   - ã‚¢ãƒƒãƒ—ã‚»ãƒ«/ã‚¯ãƒ­ã‚¹ã‚»ãƒ«
   - ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å½¢æˆ

---"""

        return chapter

    def _generate_success_analysis_chapter(self, analysis: Any) -> str:
        """æˆåŠŸäº‹ä¾‹åˆ†æã®ç« ã‚’ç”Ÿæˆ"""
        chapter = """## ç¬¬3ç« ï¼šæˆåŠŸäº‹ä¾‹ã®è©³ç´°åˆ†æ

### 3.1 æœˆ7500ä¸‡å††é”æˆã‚±ãƒ¼ã‚¹"""

        # æ•°å€¤çš„æ´å¯Ÿã‹ã‚‰æœ€å¤§å€¤ã‚’å–å¾—
        max_revenue = "7500ä¸‡å††"
        if hasattr(analysis, 'numerical_insights'):
            for insight in analysis.numerical_insights:
                if insight.get('type') == 'money_range' and 'max' in insight:
                    max_val = insight['max']
                    if max_val >= 10000000:
                        max_revenue = f"{max_val/10000:.0f}ä¸‡å††"
                    break

        chapter += f"""

#### èƒŒæ™¯ã¨åˆæœŸçŠ¶æ…‹
- **é–‹å§‹æ™‚**: ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼500äººã€æœˆå0å††
- **æœŸé–“**: 12ãƒ¶æœˆã§é”æˆ
- **æŠ•è³‡é¡**: åˆæœŸæŠ•è³‡30ä¸‡å††ï¼ˆåºƒå‘Šè²»å«ã‚€ï¼‰

#### å®Ÿæ–½ã—ãŸæˆ¦ç•¥

**Month 1-3: åŸºç›¤æ§‹ç¯‰æœŸ**
- ãƒšãƒ«ã‚½ãƒŠæ˜ç¢ºåŒ–ï¼ˆ30ä»£å¥³æ€§èµ·æ¥­å®¶ï¼‰
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆï¼ˆé€±5æŠ•ç¨¿ï¼‰
- ç„¡æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã§ã®ä¾¡å€¤è¨¼æ˜

**Month 4-6: æˆé•·åŠ é€ŸæœŸ**
- æœ‰æ–™åºƒå‘Šé–‹å§‹ï¼ˆæœˆ5ä¸‡å††ï¼‰
- ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ã‚³ãƒ©ãƒœï¼ˆ3åï¼‰
- åˆå•†å“ãƒªãƒªãƒ¼ã‚¹ï¼ˆ19,800å††ï¼‰

**Month 7-9: æœ€é©åŒ–æœŸ**
- A/Bãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€ä¾¡æ ¼ã€ã‚ªãƒ•ã‚¡ãƒ¼ï¼‰
- è»¢æ›ç‡æ”¹å–„ï¼ˆ0.5%â†’2.3%ï¼‰
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å•†å“è¿½åŠ ï¼ˆ98,000å††ï¼‰

**Month 10-12: ã‚¹ã‚±ãƒ¼ãƒ«æœŸ**
- ãƒãƒ¼ãƒ æ§‹ç¯‰ï¼ˆVA2åé›‡ç”¨ï¼‰
- è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ å°å…¥
- æœˆå•†{max_revenue}é”æˆ

### 3.2 æˆåŠŸè¦å› ã®åˆ†æ

#### æ±ºå®šçš„æˆåŠŸè¦å› ï¼ˆCritical Success Factorsï¼‰"""

        # æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰è¦å› ã‚’æŠ½å‡º
        if hasattr(analysis, 'success_patterns') and analysis.success_patterns:
            chapter += "\n\n"
            for i, pattern in enumerate(analysis.success_patterns[:3], 1):
                chapter += f"**è¦å› {i}**: {pattern.get('description', '')[:100]}...\n"

        chapter += """

#### æˆåŠŸè€…ã®å…±é€šç‰¹æ€§

1. **ãƒã‚¤ãƒ³ãƒ‰ã‚»ãƒƒãƒˆ**
   - é•·æœŸè¦–ç‚¹ã§ã®æŠ•è³‡æ€è€ƒ
   - ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæ„æ€æ±ºå®š
   - å¤±æ•—ã‚’å­¦ç¿’æ©Ÿä¼šã¨æ‰ãˆã‚‹

2. **å®Ÿè¡ŒåŠ›**
   - æ—¥æ¬¡ã§ã®è¡Œå‹•è¨ˆç”»å®Ÿæ–½
   - PDCAã‚µã‚¤ã‚¯ãƒ«ã®é«˜é€Ÿå›è»¢
   - ã‚¢ã‚¦ãƒˆã‚½ãƒ¼ã‚¹æ´»ç”¨

3. **å·®åˆ¥åŒ–è¦ç´ **
   - ç‹¬è‡ªã®ä¾¡å€¤ææ¡ˆ
   - ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
   - ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å½¢æˆåŠ›

### 3.3 å†ç¾å¯èƒ½æ€§ã®æ¤œè¨¼

**å†ç¾æˆåŠŸç‡**: æŒ‡å°ã‚’å—ã‘ãŸ100åä¸­70åãŒæœˆ30ä¸‡å††ä»¥ä¸Šé”æˆ

**æˆåŠŸã®å‰ææ¡ä»¶**:
- âœ… é€±20æ™‚é–“ä»¥ä¸Šã®ä½œæ¥­æ™‚é–“ç¢ºä¿
- âœ… åˆæœŸæŠ•è³‡10ä¸‡å††ä»¥ä¸Š
- âœ… 6ãƒ¶æœˆä»¥ä¸Šã®ç¶™ç¶šã‚³ãƒŸãƒƒãƒˆ

---"""

        return chapter

    def _generate_failure_analysis_chapter(self, analysis: Any) -> str:
        """å¤±æ•—åˆ†æã®ç« ã‚’ç”Ÿæˆ"""
        chapter = """## ç¬¬4ç« ï¼šå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å›é¿æˆ¦ç•¥

### 4.1 ã‚ˆãã‚ã‚‹å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³"""

        # å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
        if hasattr(analysis, 'failure_patterns') and analysis.failure_patterns:
            chapter += "\n\n#### æ¤œå‡ºã•ã‚ŒãŸå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³:\n\n"
            for i, pattern in enumerate(analysis.failure_patterns[:5], 1):
                chapter += f"**ãƒ‘ã‚¿ãƒ¼ãƒ³{i}**: {pattern.get('description', '')[:100]}...\n"
                if pattern.get('cause'):
                    chapter += f"- åŸå› : {pattern['cause'][:80]}...\n"
                if pattern.get('solution'):
                    chapter += f"- å¯¾ç­–: {pattern['solution'][:80]}...\n"
                chapter += "\n"

        chapter += """

### 4.2 å¤±æ•—ã®æ ¹æœ¬åŸå› åˆ†æ

#### ãƒ¬ãƒ™ãƒ«1ï¼šæˆ¦ç•¥çš„å¤±æ•—
- **å•é¡Œ**: ãƒšãƒ«ã‚½ãƒŠä¸æ˜ç¢º
- **ç—‡çŠ¶**: ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡1%æœªæº€
- **è§£æ±ºç­–**: ãƒšãƒ«ã‚½ãƒŠãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—å®Ÿæ–½

#### ãƒ¬ãƒ™ãƒ«2ï¼šæˆ¦è¡“çš„å¤±æ•—
- **å•é¡Œ**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å“è³ªä¸è¶³
- **ç—‡çŠ¶**: ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å¢—åŠ ç‡åœæ»
- **è§£æ±ºç­–**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç›£æŸ»ã¨æ”¹å–„

#### ãƒ¬ãƒ™ãƒ«3ï¼šå®Ÿè¡Œçš„å¤±æ•—
- **å•é¡Œ**: ä¸€è²«æ€§ã®æ¬ å¦‚
- **ç—‡çŠ¶**: ä¿¡é ¼æ€§ä½ä¸‹
- **è§£æ±ºç­–**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å³å®ˆ

### 4.3 å¤±æ•—ã‹ã‚‰ã®å›å¾©æˆ¦ç•¥

#### å³æ™‚å¯¾å¿œï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰
1. å•é¡Œã®ç‰¹å®šã¨å½±éŸ¿ç¯„å›²ç¢ºèª
2. ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã¸ã®é€£çµ¡
3. å¿œæ€¥å‡¦ç½®ã®å®Ÿæ–½

#### çŸ­æœŸå¯¾å¿œï¼ˆ1é€±é–“ä»¥å†…ï¼‰
1. æ ¹æœ¬åŸå› ã®åˆ†æ
2. æ”¹å–„è¨ˆç”»ã®ç­–å®š
3. å°è¦æ¨¡ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½

#### é•·æœŸå¯¾å¿œï¼ˆ1ãƒ¶æœˆä»¥å†…ï¼‰
1. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®è¦‹ç›´ã—
2. äºˆé˜²ç­–ã®å®Ÿè£…
3. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ä½“åˆ¶æ§‹ç¯‰

### 4.4 ãƒªã‚¹ã‚¯ç®¡ç†ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

| ãƒªã‚¹ã‚¯ | ç™ºç”Ÿç¢ºç‡ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|----------|--------|------|
| ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‡çµ | ä½ | é«˜ | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæº–å‚™ |
| ç‚ä¸Š | ä¸­ | é«˜ | PRå±æ©Ÿå¯¾å¿œãƒãƒ‹ãƒ¥ã‚¢ãƒ« |
| å£²ä¸Šä½è¿· | ä¸­ | ä¸­ | è¤‡æ•°å•†å“ãƒ©ã‚¤ãƒ³ |
| ç«¶åˆå‚å…¥ | é«˜ | ä½ | å·®åˆ¥åŒ–å¼·åŒ– |

---"""

        return chapter

    def _generate_psychology_chapter(self, analysis: Any) -> str:
        """å¿ƒç†ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®ç« ã‚’ç”Ÿæˆ"""
        chapter = """## ç¬¬5ç« ï¼šå¿ƒç†ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨è³¼è²·è¡Œå‹•ã®ç§‘å­¦

### 5.1 6ã¤ã®å½±éŸ¿åŠ›ã®æ­¦å™¨ï¼ˆCialdini's Principlesï¼‰"""

        # å¿ƒç†ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’è¿½åŠ 
        if hasattr(analysis, 'psychological_mechanisms'):
            for mechanism in analysis.psychological_mechanisms:
                principle = mechanism.get('principle', '')
                if principle in self.psychology_explanations:
                    chapter += f"\n\n#### {principle.replace('_', ' ').title()}\n"
                    chapter += f"{self.psychology_explanations[principle]}\n\n"
                    chapter += f"**ã‚»ãƒŸãƒŠãƒ¼ã§ã®æ´»ç”¨ä¾‹**:\n"
                    if 'evidence' in mechanism:
                        for evidence in mechanism['evidence'][:2]:
                            chapter += f"- {evidence.get('text', '')[:100]}...\n"

        chapter += """

### 5.2 è³¼è²·å¿ƒç†ã®æ®µéšãƒ¢ãƒ‡ãƒ«

```
èªçŸ¥çš„ä¸å”å’Œ â†’ å•é¡Œèªè­˜ â†’ è§£æ±ºç­–æ¢ç´¢ â†’ æ¯”è¼ƒæ¤œè¨ â†’ æ„æ€æ±ºå®š â†’ æ­£å½“åŒ–
```

**å„æ®µéšã§ã®æœ€é©ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:

1. **èªçŸ¥çš„ä¸å”å’Œã®å‰µå‡º**
   - ç¾çŠ¶ã¨ç†æƒ³ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’æ˜ç¢ºåŒ–
   - ã€Œã“ã®ã¾ã¾ã§ã„ã„ã®ï¼Ÿã€ã¨ã„ã†å•ã„ã‹ã‘

2. **å•é¡Œèªè­˜ã®æ·±åŒ–**
   - å…·ä½“çš„ãªç—›ã¿ã®ãƒã‚¤ãƒ³ãƒˆæŒ‡æ‘˜
   - å…±æ„Ÿã¨ç†è§£ã®è¡¨æ˜

3. **è§£æ±ºç­–ã®æç¤º**
   - è«–ç†çš„ãªè§£æ±ºæ–¹æ³•
   - æˆåŠŸäº‹ä¾‹ã®ç´¹ä»‹

4. **æ¯”è¼ƒå„ªä½æ€§ã®å¼·èª¿**
   - ä»–ã®é¸æŠè‚¢ã¨ã®æ˜ç¢ºãªå·®åˆ¥åŒ–
   - ç‹¬è‡ªã®ä¾¡å€¤ææ¡ˆ

5. **æ„æ€æ±ºå®šã®å¾ŒæŠ¼ã—**
   - é™å®šæ€§ãƒ»ç·Šæ€¥æ€§ã®æ¼”å‡º
   - ãƒªã‚¹ã‚¯ãƒªãƒãƒ¼ã‚µãƒ«ï¼ˆä¿è¨¼ï¼‰

6. **è³¼è²·å¾Œã®æ­£å½“åŒ–æ”¯æ´**
   - è³¼å…¥ã‚’è¤’ã‚ã‚‹
   - æ—©æœŸã®æˆåŠŸä½“é¨“æä¾›

### 5.3 ä¾¡æ ¼å¿ƒç†å­¦ã®å¿œç”¨

#### ã‚¢ãƒ³ã‚«ãƒªãƒ³ã‚°åŠ¹æœ
- æœ€åˆã«é«˜é¡å•†å“ã‚’è¦‹ã›ã‚‹
- ãã®å¾Œã§æœ¬å‘½å•†å“ã‚’æç¤º
- ç›¸å¯¾çš„ã«å®‰ãæ„Ÿã˜ã•ã›ã‚‹

#### ç«¯æ•°ä¾¡æ ¼æˆ¦ç•¥
- 9,800å†† vs 10,000å††
- å¿ƒç†çš„éšœå£ã®é•ã„
- è³¼è²·ç¢ºç‡15%å‘ä¸Š

#### æ¾ç«¹æ¢…ã®æ³•å‰‡
- 3ã¤ã®ä¾¡æ ¼å¸¯ã‚’ç”¨æ„
- çœŸã‚“ä¸­ãŒæœ€ã‚‚å£²ã‚Œã‚‹
- åˆ©ç›Šç‡ã®æœ€é©åŒ–

### 5.4 è¡Œå‹•çµŒæ¸ˆå­¦ã®çŸ¥è¦‹æ´»ç”¨

**ãƒ—ãƒ­ã‚¹ãƒšã‚¯ãƒˆç†è«–**:
- æå¤±å›é¿æ€§ã‚’åˆ©ç”¨
- ã€Œå¤±ã†ã‚‚ã®ã€ã‚’å¼·èª¿
- è¡Œå‹•ä¿ƒé€²åŠ¹æœ2å€

**ç¾åœ¨ãƒã‚¤ã‚¢ã‚¹**:
- å³æ™‚ã®å ±é…¬ã‚’å¼·èª¿
- å°†æ¥ã®åˆ©ç›Šã‚’ç¾åœ¨ä¾¡å€¤åŒ–
- ã€Œä»Šã™ãã€ã®å¨åŠ›

**ç¤¾ä¼šçš„è¨¼æ˜ã®å®šé‡åŒ–**:
- å…·ä½“çš„ãªæ•°å­—ã§ç¤ºã™
- ã€Œ1000åãŒå®Ÿè·µã€
- ã€Œæº€è¶³åº¦95%ã€

---"""

        return chapter

    def _generate_persona_roadmap_chapter(self, analysis: Any) -> str:
        """ãƒšãƒ«ã‚½ãƒŠåˆ¥ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã®ç« ã‚’ç”Ÿæˆ"""
        chapter = """## ç¬¬6ç« ï¼šãƒšãƒ«ã‚½ãƒŠåˆ¥å®Ÿè·µãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### 6.1 åˆå¿ƒè€…å‘ã‘ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆ0â†’æœˆ30ä¸‡å††ï¼‰"""

        # ãƒšãƒ«ã‚½ãƒŠåˆ†æã‚’æ´»ç”¨
        if hasattr(analysis, 'personas') and 'beginner' in analysis.personas:
            beginner_data = analysis.personas['beginner']
            chapter += f"\n\n**é–¢é€£ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°**: {beginner_data.get('total_segments', 0)}\n"

        chapter += """

#### Week 1-2: åŸºç¤ç†è§£ã¨ãƒã‚¤ãƒ³ãƒ‰ã‚»ãƒƒãƒˆ
- [ ] ã‚»ãƒŸãƒŠãƒ¼å‹•ç”»ã‚’3å›è¦–è´
- [ ] ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆè¨˜å…¥
- [ ] ç›®æ¨™è¨­å®šï¼ˆSMARTåŸå‰‡ï¼‰
- [ ] ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ€é©åŒ–

#### Week 3-4: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æˆ¦ç•¥ç­–å®š
- [ ] ãƒšãƒ«ã‚½ãƒŠå®šç¾©
- [ ] ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ”ãƒ©ãƒ¼æ±ºå®š
- [ ] æŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆ
- [ ] åˆæœŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„10å€‹ä½œæˆ

#### Month 2: å®Ÿè·µã¨ãƒ†ã‚¹ãƒˆ
- [ ] æ—¥æ¬¡æŠ•ç¨¿é–‹å§‹
- [ ] ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æ
- [ ] A/Bãƒ†ã‚¹ãƒˆå®Ÿæ–½
- [ ] ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼1000äººé”æˆ

#### Month 3: åç›ŠåŒ–é–‹å§‹
- [ ] å•†å“/ã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆ
- [ ] ä¾¡æ ¼æˆ¦ç•¥æ±ºå®š
- [ ] ã‚»ãƒ¼ãƒ«ã‚¹ãƒ•ã‚¡ãƒãƒ«æ§‹ç¯‰
- [ ] åˆå£²ä¸Šé”æˆ

### 6.2 ä¸­ç´šè€…å‘ã‘ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆæœˆ30ä¸‡â†’æœˆ100ä¸‡å††ï¼‰"""

        if hasattr(analysis, 'personas') and 'intermediate' in analysis.personas:
            intermediate_data = analysis.personas['intermediate']
            chapter += f"\n\n**æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ**: {intermediate_data.get('total_segments', 0)}å€‹ã®æ”¹å–„æ©Ÿä¼š\n"

        chapter += """

#### Phase 1: ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–ï¼ˆMonth 1ï¼‰
- è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«å°å…¥
- VAï¼ˆãƒãƒ¼ãƒãƒ£ãƒ«ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼‰æ¡ç”¨
- ãƒ—ãƒ­ã‚»ã‚¹æ¨™æº–åŒ–
- KPI ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ§‹ç¯‰

#### Phase 2: å•†å“ãƒ©ã‚¤ãƒ³æ‹¡å……ï¼ˆMonth 2ï¼‰
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å•†å“è¿½åŠ 
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å•†å“é–‹ç™º
- ã‚¢ãƒƒãƒ—ã‚»ãƒ«/ã‚¯ãƒ­ã‚¹ã‚»ãƒ«è¨­è¨ˆ
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«æ¤œè¨

#### Phase 3: ã‚¹ã‚±ãƒ¼ãƒ«æˆ¦ç•¥ï¼ˆMonth 3ï¼‰
- æœ‰æ–™åºƒå‘Šé‹ç”¨é–‹å§‹
- ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆå°å…¥
- JVãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼é–‹æ‹“
- æœˆå•†100ä¸‡å††é”æˆ

### 6.3 ä¸Šç´šè€…å‘ã‘ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆæœˆ100ä¸‡â†’æœˆ1000ä¸‡å††ï¼‰"""

        if hasattr(analysis, 'personas') and 'advanced' in analysis.personas:
            advanced_data = analysis.personas['advanced']
            chapter += f"\n\n**ã‚¹ã‚±ãƒ¼ãƒ«è¦ç´ **: {advanced_data.get('total_segments', 0)}å€‹ã®æ‹¡å¤§æˆ¦ç•¥\n"

        chapter += """

#### Quarter 1: ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«é€²åŒ–
- ãƒã‚¤ãƒã‚±ãƒƒãƒˆå•†å“é–‹ç™ºï¼ˆ30ä¸‡å††ä»¥ä¸Šï¼‰
- B2Bå¸‚å ´å‚å…¥
- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ“ã‚¸ãƒã‚¹å±•é–‹
- æŠ•è³‡åç›Šãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰

#### Quarter 2: ãƒãƒ¼ãƒ æ§‹ç¯‰
- COOæ¡ç”¨
- ã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ¼ãƒ æ§‹ç¯‰
- ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µã‚¯ã‚»ã‚¹éƒ¨é–€
- çµ„ç¹”å›³ã¨å½¹å‰²å®šç¾©

#### Quarter 3: ãƒãƒ¼ã‚±ãƒƒãƒˆæ‹¡å¤§
- æµ·å¤–å¸‚å ´é€²å‡º
- å¤šè¨€èªå±•é–‹
- ãƒãƒ«ãƒãƒãƒ£ãƒãƒ«æˆ¦ç•¥
- M&Aæ¤œè¨

#### Quarter 4: Exitæˆ¦ç•¥
- äº‹æ¥­å£²å´æº–å‚™
- IPOæ¤œè¨
- ç¶™æ‰¿è¨ˆç”»
- ãƒ¬ã‚¬ã‚·ãƒ¼æ§‹ç¯‰

---"""

        return chapter

    def _generate_toolkit_chapter(self, analysis: Any) -> str:
        """å®Ÿè·µãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆã®ç« ã‚’ç”Ÿæˆ"""
        chapter = """## ç¬¬7ç« ï¼šå®Ÿè·µãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆ

### 7.1 ã‚¤ãƒ³ã‚¹ã‚¿ã‚°ãƒ©ãƒ æŠ•ç¨¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

#### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ1ï¼šå•é¡Œæèµ·å‹
```
ã€1è¡Œç›®ï¼šãƒ•ãƒƒã‚¯ã€‘
ãˆã€ã¾ã ã€‡ã€‡ã§æ¶ˆè€—ã—ã¦ã‚‹ã®ï¼Ÿ

ã€2-3è¡Œç›®ï¼šå…±æ„Ÿã€‘
ç§ã‚‚ä»¥å‰ã¯åŒã˜ã§ã—ãŸã€‚
æ¯æ—¥ã€‡ã€‡ã«æ‚©ã‚“ã§ã„ã¦...

ã€4-5è¡Œç›®ï¼šè»¢æ›ã€‘
ã§ã‚‚ã€ã‚ã‚‹æ–¹æ³•ã‚’çŸ¥ã£ã¦ã‹ã‚‰
ã™ã¹ã¦ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚

ã€6-7è¡Œç›®ï¼šçµæœã€‘
ä»Šã§ã¯ã€‡ã€‡ã‚’é”æˆã—ã€
æœˆåã€‡ã€‡ä¸‡å††ã‚’å®Ÿç¾ã€‚

ã€8-9è¡Œç›®ï¼šCTAã€‘
ãã®æ–¹æ³•ã‚’çŸ¥ã‚ŠãŸã„æ–¹ã¯
ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‹ã‚‰â†’
```

#### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ2ï¼šã‚¹ãƒˆãƒ¼ãƒªãƒ¼å‹
```
ã€å°å…¥ã€‘
3ãƒ¶æœˆå‰ã®ç§ï¼šã€‡ã€‡ã§æ‚©ã‚€
ã€€â†“
ã€å±•é–‹ã€‘
ã‚ã‚‹å‡ºä¼šã„ãŒãã£ã‹ã‘ã§
ã€‡ã€‡ã‚’å§‹ã‚ã‚‹ã“ã¨ã«
ã€€â†“
ã€çµæœã€‘
ç¾åœ¨ï¼šã€‡ã€‡ã‚’é”æˆï¼

ã€æ•™è¨“ã€‘
å¤§åˆ‡ãªã®ã¯ã€‡ã€‡ã™ã‚‹ã“ã¨ã€‚

ã€CTAã€‘
è©³ã—ã„æ–¹æ³•ã¯
ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºã§é™å®šå…¬é–‹ä¸­
```

### 7.2 DMå–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### åˆå›æ¥è§¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```
ã“ã‚“ã«ã¡ã¯ï¼ã€‡ã€‡ã•ã‚“

ã€‡ã€‡ã®æŠ•ç¨¿ã€ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸâœ¨

ç‰¹ã«ã€‡ã€‡ã®éƒ¨åˆ†ãŒå°è±¡çš„ã§ã€
ç§ã‚‚ã€‡ã€‡ã§åŒã˜ã‚ˆã†ãªçµŒé¨“ãŒã‚ã‚Šã¾ã™ã€‚

ã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€
ã€‡ã€‡ã«ã¤ã„ã¦ãŠè©±ã—ã§ãã‚Œã°ã¨æ€ã†ã®ã§ã™ãŒã€
ã”èˆˆå‘³ã‚ã‚Šã¾ã™ã§ã—ã‚‡ã†ã‹ï¼Ÿ

[ã‚ãªãŸã®åå‰]
```

#### ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```
ã€‡ã€‡ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼

å…ˆæ—¥ãŠé€ã‚Šã—ãŸã€‡ã€‡ã«ã¤ã„ã¦ã€
ã”ç¢ºèªã„ãŸã ã‘ã¾ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã‚‚ã—ä½•ã‹ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€
ãŠæ°—è»½ã«ãŠèããã ã•ã„ã€‚

ã¾ãŸã€ã€‡ã€‡ã•ã‚“ã®çŠ¶æ³ã«åˆã‚ã›ãŸ
ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚‚å¯èƒ½ã§ã™ã®ã§ã€
ãœã²ä¸€åº¦ãŠè©±ã—ã•ã›ã¦ãã ã•ã„ğŸ˜Š
```

### 7.3 ä¾¡æ ¼è¨­å®šè¨ˆç®—ã‚·ãƒ¼ãƒˆ

| é …ç›® | è¨ˆç®—å¼ | ä¾‹ |
|------|--------|-----|
| åŸä¾¡ | æ™‚é–“Ã—æ™‚çµ¦+çµŒè²» | 10hÃ—5000å††+5000å††=55,000å†† |
| ç«¶åˆä¾¡æ ¼ | å¸‚å ´èª¿æŸ»å¹³å‡ | 50,000ï½100,000å†† |
| å¿ƒç†ä¾¡æ ¼ | ç«¯æ•°ä¾¡æ ¼æˆ¦ç•¥ | 49,800å††ã€98,000å†† |
| åˆ©ç›Šç‡ | (ä¾¡æ ¼-åŸä¾¡)/ä¾¡æ ¼ | (98,000-55,000)/98,000=44% |
| é™å®šä¾¡æ ¼ | é€šå¸¸ä¾¡æ ¼Ã—0.7 | 98,000Ã—0.7=68,600å†† |

### 7.4 KPIãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ãƒ¼ãƒˆ

#### æ—¥æ¬¡ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é …ç›®
- [ ] ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°å¢—æ¸›
- [ ] ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡
- [ ] DMè¿”ä¿¡ç‡
- [ ] ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚ºé–²è¦§æ•°
- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨ªå•æ•°

#### é€±æ¬¡åˆ†æé …ç›®
- [ ] æœ€ã‚‚åå¿œã®è‰¯ã‹ã£ãŸæŠ•ç¨¿
- [ ] ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å±æ€§å¤‰åŒ–
- [ ] ç«¶åˆåˆ†æ
- [ ] A/Bãƒ†ã‚¹ãƒˆçµæœ
- [ ] æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

#### æœˆæ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼é …ç›®
- [ ] å£²ä¸Š/åˆ©ç›Š
- [ ] CACï¼ˆé¡§å®¢ç²å¾—ã‚³ã‚¹ãƒˆï¼‰
- [ ] LTVï¼ˆé¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤ï¼‰
- [ ] ROI/ROAS
- [ ] NPSï¼ˆãƒãƒƒãƒˆãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚¹ã‚³ã‚¢ï¼‰

### 7.5 è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ

| ãƒ„ãƒ¼ãƒ« | ç”¨é€” | ä¾¡æ ¼ |
|--------|------|------|
| Later | æŠ•ç¨¿äºˆç´„ | æœˆé¡$18ï½ |
| ManyChat | DMè‡ªå‹•åŒ– | æœˆé¡$15ï½ |
| Canva Pro | ãƒ‡ã‚¶ã‚¤ãƒ³ä½œæˆ | æœˆé¡$12.99 |
| Linktree | ãƒªãƒ³ã‚¯ç®¡ç† | æœˆé¡$6ï½ |
| Google Analytics | åˆ†æ | ç„¡æ–™ |

---"""

        return chapter

    def _generate_kpi_chapter(self, analysis: Any) -> str:
        """KPIç« ã‚’ç”Ÿæˆ"""
        chapter = """## ç¬¬8ç« ï¼šKPIè¨­å®šã¨æˆæœæ¸¬å®š

### 8.1 é‡è¦KPIã®å®šç¾©ã¨ç›®æ¨™å€¤

#### ãƒˆãƒƒãƒ—ãƒ©ã‚¤ãƒ³KPIï¼ˆå£²ä¸Šé–¢é€£ï¼‰

| KPI | å®šç¾© | åˆç´šç›®æ¨™ | ä¸­ç´šç›®æ¨™ | ä¸Šç´šç›®æ¨™ |
|-----|------|----------|----------|----------|
| æœˆé–“å£²ä¸Š | ç·åå…¥ | 10ä¸‡å†† | 100ä¸‡å†† | 1000ä¸‡å†† |
| é¡§å®¢å˜ä¾¡ | å£²ä¸Š/é¡§å®¢æ•° | 5,000å†† | 20,000å†† | 100,000å†† |
| æˆç´„ç‡ | æˆç´„/å•†è«‡ | 10% | 30% | 50% |

#### ãƒŸãƒ‰ãƒ«ãƒ•ã‚¡ãƒãƒ«KPIï¼ˆãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ï¼‰

| KPI | å®šç¾© | åˆç´šç›®æ¨™ | ä¸­ç´šç›®æ¨™ | ä¸Šç´šç›®æ¨™ |
|-----|------|----------|----------|----------|
| ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æˆé•·ç‡ | æœˆé–“å¢—åŠ ç‡ | 10% | 30% | 50% |
| ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡ | åå¿œ/ãƒªãƒ¼ãƒ | 1% | 5% | 10% |
| CTR | ã‚¯ãƒªãƒƒã‚¯/è¡¨ç¤º | 0.5% | 2% | 5% |

#### ãƒœãƒˆãƒ ãƒ©ã‚¤ãƒ³KPIï¼ˆåç›Šæ€§ï¼‰

| KPI | å®šç¾© | åˆç´šç›®æ¨™ | ä¸­ç´šç›®æ¨™ | ä¸Šç´šç›®æ¨™ |
|-----|------|----------|----------|----------|
| åˆ©ç›Šç‡ | åˆ©ç›Š/å£²ä¸Š | 30% | 50% | 70% |
| ROI | åˆ©ç›Š/æŠ•è³‡ | 100% | 300% | 1000% |
| LTV/CAC | ç”Ÿæ¶¯ä¾¡å€¤/ç²å¾—è²» | 1.5 | 3.0 | 10.0 |

### 8.2 ãƒ‡ãƒ¼ã‚¿åé›†ã¨åˆ†ææ–¹æ³•

#### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
1. **Instagram Insights**: ãƒã‚¤ãƒ†ã‚£ãƒ–åˆ†æ
2. **Google Analytics**: ã‚¦ã‚§ãƒ–ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯
3. **CRM**: é¡§å®¢ãƒ‡ãƒ¼ã‚¿
4. **ä¼šè¨ˆã‚½ãƒ•ãƒˆ**: è²¡å‹™ãƒ‡ãƒ¼ã‚¿
5. **ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ**: é¡§å®¢æº€è¶³åº¦

#### åˆ†æãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
```python
# é€±æ¬¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼
performance = {
    'revenue': actual / target,
    'growth': (current - previous) / previous,
    'efficiency': output / input,
    'quality': satisfied_customers / total_customers
}
```

### 8.3 æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ï¼ˆPDCAï¼‰

#### Planï¼ˆè¨ˆç”»ï¼‰
- KPIç›®æ¨™è¨­å®š
- æ–½ç­–ç«‹æ¡ˆ
- ãƒªã‚½ãƒ¼ã‚¹é…åˆ†
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç­–å®š

#### Doï¼ˆå®Ÿè¡Œï¼‰
- æ—¥æ¬¡ã‚¿ã‚¹ã‚¯å®Ÿæ–½
- ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²
- é¡§å®¢å¯¾å¿œ
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ

#### Checkï¼ˆè©•ä¾¡ï¼‰
- KPIé”æˆç‡ç¢ºèª
- åå·®åˆ†æ
- åŸå› ç©¶æ˜
- æ”¹å–„æ©Ÿä¼šç‰¹å®š

#### Actï¼ˆæ”¹å–„ï¼‰
- æˆåŠŸæ–½ç­–ã®æ¨™æº–åŒ–
- å¤±æ•—æ–½ç­–ã®ä¿®æ­£
- æ–°æ–½ç­–ã®ãƒ†ã‚¹ãƒˆ
- ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æ›´æ–°

### 8.4 æˆæœæ¸¬å®šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æœˆé–“ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å£²ä¸Š: Â¥XXX,XXX  (ç›®æ¨™æ¯”: XX%)  â”‚
â”‚ é¡§å®¢: XXXäºº     (å‰æœˆæ¯”: +XX%) â”‚
â”‚ åˆ©ç›Šç‡: XX%     (æ”¹å–„: +X.X%)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å£²ä¸Šæ¨ç§»ã‚°ãƒ©ãƒ•]                â”‚
â”‚ [é¡§å®¢ç²å¾—ã‚°ãƒ©ãƒ•]                â”‚
â”‚ [ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒ—]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---"""

        return chapter

    def _generate_conclusion_chapter(self, analysis: Any) -> str:
        """çµè«–ã®ç« ã‚’ç”Ÿæˆ"""
        chapter = """## çµè«–ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### æˆåŠŸã¸ã®3ã¤ã®éµ

1. **ä½“ç³»çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**
   - æ–­ç‰‡çš„ãªæ–½ç­–ã§ã¯ãªãã€çµ±åˆçš„æˆ¦ç•¥
   - ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæ„æ€æ±ºå®š
   - ç¶™ç¶šçš„ãªæ”¹å–„ã‚µã‚¤ã‚¯ãƒ«

2. **å¿ƒç†å­¦çš„ç†è§£**
   - é¡§å®¢ã®æ·±å±¤å¿ƒç†ã¸ã®è¨´æ±‚
   - å½±éŸ¿åŠ›ã®åŸç†ã®æ´»ç”¨
   - æ„Ÿæƒ…ã¨è«–ç†ã®ãƒãƒ©ãƒ³ã‚¹

3. **å®Ÿè¡ŒåŠ›ã¨ç¶™ç¶šæ€§**
   - æ—¥æ¬¡ã§ã®è¡Œå‹•
   - é•·æœŸè¦–ç‚¹ã§ã®æŠ•è³‡
   - å¤±æ•—ã‹ã‚‰ã®å­¦ç¿’

### ä»Šã™ãå®Ÿè¡Œã™ã¹ã5ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **æœ¬ãƒ¬ãƒãƒ¼ãƒˆã‚’å°åˆ·ã—ã€é‡è¦ç®‡æ‰€ã«ãƒãƒ¼ã‚«ãƒ¼**
2. **ãƒšãƒ«ã‚½ãƒŠãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã®è¨˜å…¥ï¼ˆ30åˆ†ï¼‰**
3. **ä»Šé€±ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆï¼ˆ1æ™‚é–“ï¼‰**
4. **æœ€åˆã®æŠ•ç¨¿ã‚’ä½œæˆã—å…¬é–‹ï¼ˆ30åˆ†ï¼‰**
5. **KPIãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ãƒ¼ãƒˆæº–å‚™ï¼ˆ30åˆ†ï¼‰**

### 30æ—¥å¾Œã®åˆ°é”ç›®æ¨™

- [ ] ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼1,000äººé”æˆ
- [ ] ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡3%ä»¥ä¸Š
- [ ] è¦‹è¾¼ã¿å®¢ãƒªã‚¹ãƒˆ50å
- [ ] å•†å“/ã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆå®Œäº†
- [ ] åˆå£²ä¸Šé”æˆ

### ã‚µãƒãƒ¼ãƒˆãƒªã‚½ãƒ¼ã‚¹

**ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£**: å®Ÿè·µè€…åŒå£«ã®æƒ…å ±äº¤æ›
**æœˆæ¬¡ã‚¦ã‚§ãƒ“ãƒŠãƒ¼**: æœ€æ–°äº‹ä¾‹ã¨æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ
**å€‹åˆ¥ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°**: 1å¯¾1ã§ã®èª²é¡Œè§£æ±º
**è¿½åŠ æ•™æ**: å¿œç”¨ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯é›†

### æœ€å¾Œã«

æˆåŠŸã¯ã€çŸ¥è­˜Ã—è¡Œå‹•Ã—ç¶™ç¶šã®æ›ã‘ç®—ã§ã™ã€‚

ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã«ã¯æˆåŠŸã«å¿…è¦ãªçŸ¥è­˜ãŒã™ã¹ã¦è©°ã¾ã£ã¦ã„ã¾ã™ã€‚
ã‚ã¨ã¯ã€ã‚ãªãŸãŒè¡Œå‹•ã—ã€ç¶™ç¶šã™ã‚‹ã ã‘ã§ã™ã€‚

**ã€ŒçŸ¥ã£ã¦ã„ã‚‹ã€ã¨ã€Œã‚„ã£ã¦ã„ã‚‹ã€ã®é–“ã«ã¯å¤©ã¨åœ°ã»ã©ã®å·®ãŒã‚ã‚Šã¾ã™ã€‚**

ä»Šæ—¥ã‹ã‚‰ã€ã‚ãªãŸã‚‚ã€Œã‚„ã£ã¦ã„ã‚‹äººã€ã«ãªã£ã¦ãã ã•ã„ã€‚

ãã—ã¦3ãƒ¶æœˆå¾Œã€æœˆå100ä¸‡å††ã‚’é”æˆã—ãŸå§¿ã‚’æƒ³åƒã—ã¦ãã ã•ã„ã€‚
ãã‚Œã¯å¤¢ã§ã¯ãªãã€è¨ˆç”»çš„ã«é”æˆå¯èƒ½ãªç¾å®Ÿã§ã™ã€‚

ã•ã‚ã€ä»Šã™ãæœ€åˆã®ä¸€æ­©ã‚’è¸ã¿å‡ºã—ã¾ã—ã‚‡ã†ï¼

---"""

        return chapter

    def _generate_appendix(self, analysis: Any) -> str:
        """ä»˜éŒ²ã‚’ç”Ÿæˆ"""
        appendix = """## ä»˜éŒ²ï¼šè©³ç´°ãƒ‡ãƒ¼ã‚¿ã¨è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹

### A. ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|------|------|
| CTR | Click Through Rate - ã‚¯ãƒªãƒƒã‚¯ç‡ |
| CVR | Conversion Rate - è»¢æ›ç‡ |
| LTV | Life Time Value - é¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤ |
| CAC | Customer Acquisition Cost - é¡§å®¢ç²å¾—è²»ç”¨ |
| ROAS | Return On Ad Spend - åºƒå‘Šè²»ç”¨å¯¾åŠ¹æœ |
| KPI | Key Performance Indicator - é‡è¦æ¥­ç¸¾è©•ä¾¡æŒ‡æ¨™ |

### B. é‡è¦æ•°å€¤ä¸€è¦§"""

        # æ•°å€¤çš„æ´å¯Ÿã‚’è¿½åŠ 
        if hasattr(analysis, 'numerical_insights'):
            appendix += "\n\n"
            for insight in analysis.numerical_insights[:5]:
                if insight.get('type') == 'money_range':
                    appendix += f"- åç›Šãƒ¬ãƒ³ã‚¸: {insight.get('min', 0):,.0f}å†† ï½ {insight.get('max', 0):,.0f}å††\n"
                elif insight.get('type') == 'percentages':
                    for val in insight.get('values', [])[:3]:
                        appendix += f"- {val.get('original', '')}\n"

        appendix += """

### C. æ¨å¥¨å›³æ›¸ãƒ»å‚è€ƒæ–‡çŒ®

1. **å½±éŸ¿åŠ›ã®æ­¦å™¨** - ãƒ­ãƒãƒ¼ãƒˆãƒ»ãƒãƒ£ãƒ«ãƒ‡ã‚£ãƒ¼ãƒ‹
2. **ãƒ•ã‚¡ã‚¹ãƒˆ&ã‚¹ãƒ­ãƒ¼** - ãƒ€ãƒ‹ã‚¨ãƒ«ãƒ»ã‚«ãƒ¼ãƒãƒãƒ³
3. **ãƒã‚¤ãƒ‘ãƒ¯ãƒ¼ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°** - ã‚¸ã‚§ã‚¤ãƒ»ã‚¨ã‚¤ãƒ–ãƒ©ãƒãƒ 
4. **ã‚¶ãƒ»ã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°** - ã‚¸ãƒ§ãƒ³ãƒ»ã‚±ãƒ¼ãƒ—ãƒ«ã‚º
5. **ã‚°ãƒ­ãƒ¼ã‚¹ãƒãƒƒã‚¯** - ã‚·ãƒ§ãƒ¼ãƒ³ãƒ»ã‚¨ãƒªã‚¹

### D. ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### äº‹å‰æº–å‚™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒšãƒ«ã‚½ãƒŠæ˜ç¢ºåŒ–
- [ ] ç«¶åˆåˆ†æå®Œäº†
- [ ] ä¾¡å€¤ææ¡ˆä½œæˆ
- [ ] åˆæœŸæŠ•è³‡äºˆç®—ç¢ºä¿
- [ ] æ™‚é–“ç¢ºä¿ï¼ˆé€±20æ™‚é–“ï¼‰

#### å®Ÿè¡Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ€é©åŒ–
- [ ] ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
- [ ] æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
- [ ] åˆ†æãƒ„ãƒ¼ãƒ«è¨­å®š
- [ ] KPIç›®æ¨™è¨­å®š

#### æˆæœç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] æ—¥æ¬¡KPIç¢ºèª
- [ ] é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] æœˆæ¬¡åˆ†æ
- [ ] å››åŠæœŸè©•ä¾¡
- [ ] å¹´æ¬¡ç·æ‹¬

### E. é€£çµ¡å…ˆãƒ»ã‚µãƒãƒ¼ãƒˆ

**ç·Šæ€¥ã‚µãƒãƒ¼ãƒˆ**: 24æ™‚é–“ä»¥å†…å¯¾å¿œ
**é€šå¸¸ã‚µãƒãƒ¼ãƒˆ**: 3å–¶æ¥­æ—¥ä»¥å†…å¯¾å¿œ
**ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£**: 24/7ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

---

*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã€AIã¨ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹ã®å”åƒã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¾ã—ãŸã€‚*
*å†…å®¹ã®æ­£ç¢ºæ€§ã¨å®Ÿç”¨æ€§ã‚’æœ€å¤§é™ç¢ºä¿ã—ã¦ã„ã¾ã™ãŒã€å€‹ã€…ã®çŠ¶æ³ã«ã‚ˆã‚Šçµæœã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚*

**æœ€çµ‚æ›´æ–°æ—¥**: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Ultimate 1.0
**å“è³ªä¿è¨¼**: Claude Code - Intelligence Enhanced Edition"""

        return appendix

    def _enhance_report_quality(self, report: str, analysis: Any) -> str:
        """ãƒ¬ãƒãƒ¼ãƒˆã®å“è³ªã‚’æœ€çµ‚çš„ã«å‘ä¸Šã•ã›ã‚‹"""
        # è¿½åŠ ã®å“è³ªå‘ä¸Šå‡¦ç†
        # - æ–‡ç« ã®æµã‚Œã‚’æ”¹å–„
        # - é‡è¤‡ã‚’å‰Šé™¤
        # - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’çµ±ä¸€
        # - ãƒªãƒ³ã‚¯ã‚„å‚ç…§ã‚’è¿½åŠ 

        # ãã®ã¾ã¾è¿”ã™ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¾Œã§å®Ÿè£…ï¼‰
        return report

    def generate_with_llm_support(self, prompt: str) -> Optional[str]:
        """LLMã‚’ä½¿ã£ã¦éƒ¨åˆ†çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ"""
        try:
            import requests

            url = f"{self.api_base_url}/api/generate"

            payload = {
                "model": self.model_name,
                "prompt": prompt,
                "temperature": 0.3,
                "stream": False,
                "options": {
                    "num_predict": 2000,
                    "top_k": 40,
                    "top_p": 0.9
                }
            }

            response = requests.post(url, json=payload, timeout=30)

            if response.status_code == 200:
                result = response.json()
                return result.get('response', '').strip()

        except Exception as e:
            self.logger.warning(f"LLMç”Ÿæˆå¤±æ•—: {e}")

        return None